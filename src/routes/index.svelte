<script>
import { onMount } from "svelte";
import { goto } from "$app/navigation";

let appSession;
let mounted = false;
let username = '';

export let flags;
export let SessionName;

onMount(async () => {
	appSession = await getSession();
	mounted = true;
});

async function getSession(){
	return await penTestDb
					.get(SessionName)
					.then(function (doc) {
						return doc;
					}).catch(function (err) {
						return false;
					});
}

async function createSession(){
	const tmp = {
		_id: SessionName,
		User: username,
		Flags: [
			flags
		]
	}

	await penTestDb.put(tmp);
	goto('/app', {replaceState:true});
}

async function deleteSession(){
	await penTestDb.get(SessionName).then(function(doc) {
  		penTestDb.remove(doc);
	});
	appSession = false;
}

</script>

<svelte:head>
	<title>Cyber Trainer</title>
</svelte:head>
<div class="hero min-h-screen bg-base-200">
	<div class="hero-content text-center">
		<div class="max-w-md">
			<div class="card flex-shrink-0 w-full max-w-sm shadow-2xl bg-base-100">
				<div class="card-body">
					<div class="w-full">
						<div class="logo-only ml-auto mr-auto"></div>
					</div>
					{#if appSession && mounted}
						<p class="py-6">
							<span class="text-xl font-bold">Hello {appSession.User}!</span><br />
							Ready to keep playing?
						</p>
						<a href="/app" class="btn">Keep Playing</a>
						<button class="btn btn-xs btn-ghost" on:click={async (e) => deleteSession()}>Start Over</button>
					{:else if mounted}
						<p class="py-6">
							Let's play some capture the flag!<br />To get started, first enter a screen name for your account.
						</p>
						<input class="input input-bordered input-sm w-full max-w-xs focus:ring-0" type="text" placeholder="Enter Your Name" bind:value={username}/>
						<button class="btn" on:click={async (e) => createSession()} disabled={(!username || /^\s*$/.test(username))}>Begin</button>
					{:else}
						<div></div>
					{/if}
				</div>
			</div>
		</div>
	</div>
</div>