
export default function initXTerm(){

    let term = new window.Terminal({
        //fontFamily: '"Cascadia Code", Menlo, monospace',
        cursorBlink: true,
        convertEol: true
    });

    let isWaitingOnInput = false;

    term.open(document.getElementById('terminal'));
    term.writeln('Try running `help`.');
    term.write('\r\n$ ');

    term.onData(e => {
        switch (e) {
        case '\u0003': // Ctrl+C
            //TODO: either remove this or make it break timeouts
            term.write('^C');
            prompt();
            break;
        case '\r': // Enter
            runCommand(command);
            command = '';
            break;
        case '\u007F': // Backspace (DEL)
            if (term._core.buffer.x > 2) {
                term.write('\b \b');
                if (command.length > 0) {
                    command = command.substr(0, command.length - 1);
                }
            }
            break;
        default: // Print all other characters
            if (e >= String.fromCharCode(0x20) && e <= String.fromCharCode(0x7E) || e >= '\u00a0') {
                command += e;
                term.write(e);
            }
        }
    });
    

    function runCommand(text) {
        if(isWaitingOnInput){
            commands["ssh"].f(text);
            return; 
        }

        const input = text.trim().split(' ');
        const command = input[0];
        const param = input[1];
        const param2 = input[2];
        const param3 = input[3];

        if (command.length > 0) {
            term.writeln('');
            if (command in commands) {
                commands[command].f(param, param2, param3);
                return;
            }
            term.writeln(`${command}: command not found`);
        }
        prompt();
    }

    function prompt() {
        command = '';
        term.write('\r\n$ ');
    }

    var isWebglEnabled = false;
    try {
        const webgl = new window.WebglAddon.WebglAddon();
        term.loadAddon(webgl);
        isWebglEnabled = true;
    } catch (e) {
        console.warn('WebGL addon threw an exception during load', e);
    }

    let command = '';
    let commands = {
        help: {
            f: () => {
                term.writeln([
                '',
                ...Object.keys(commands).map(e => `  ${e.padEnd(10)} ${commands[e].description}`)
                ].join('\n\r'));
                prompt();
            },
            description: 'list available commands',
        },
        ls: {
            f: async () => {
                await test();
                term.writeln(['common_directories.txt', 'common_passwords.txt'].join('\r\n'));
                prompt();
            },
            description: 'list directory contents'
        },
        clear: {
            f: () => {
                term.clear();
                prompt();
            }, 
            description: 'clear the terminal'
        },
        scan: {
            f: (param) => {
                let i = 0;
                if(param === "common_passwords.txt"){
                    term.writeln("");
                    prompt();
                    return;
                }else if(param !== "common_directories.txt"){
                    term.writeln("File not found " + param);
                    prompt();
                    return;
                }
                scanDirectories(i);
            },
            description: `scan the site for common directories and files using a wordlist \r\n ${"(Example: scan wordlist.txt)".padStart(40)}`
        },
        force: {
            f: async (param1, param2, param3) => {
                let i = 0;
                if(param2 !== "common_directories.txt" && param2 !== "common_passwords.txt"){
                    term.writeln("File not found " + param2);
                    prompt();
                    return;
                }
                await force(i, param1, param2, param3);
            },
            description: `try a combination of a username with a password list at a location \r\n ${"(Example: force john passwords.txt /account)".padStart(56)}`
        },
        ssh: {
            f: async (param) => {
                if(!isWaitingOnInput){
                    let res = await validateSSH(param);
                    term.write(res.message);
                    if(res.message === 'Connection refused.')
                        prompt();
                    else
                        isWaitingOnInput = true;
                }else{
                    let res = await validateSSHPW(param);
                    term.writeln('');
                    term.write(res.message);
                    prompt();
                    isWaitingOnInput = false;
                }

                
            },
            description: `SSH remote login client  \r\n ${"(Example: ssh john@192.168.0.100)".padStart(45)}`
        },
        base64: {
            f: (param1, param2) => {
                base64(param1, param2);
            },
            description: `Encode or decode base64 \r\n ${"(Example: base64 -e/-d yourinput)".padStart(45)}`
        }
    };

    let directories = ["/app", "/dev", "/app/admin", "/app/profile", "/app/shop", "/app/contact", "/app/cart", "robots.txt"];
    function scanDirectories(i) {        
        setTimeout(function() {   
            term.writeln(directories[i]);
            i++;                  
            if (i < directories.length) {           
                scanDirectories(i);             
            }else{
                prompt();                       
            }
        }, 1000)
    }

    async function force(i, username, file, location){
        setTimeout(async function(){
            i++;
            if(i == 1)
                term.writeln("Trying combinations of " + username + " and passwords from " + file + " at " + location);
            else if(i < 5)
                term.writeln(".");
            else if(i == 5){
                var res = await validateForce(username, file, location);
                term.writeln(res.message);
            }

            if(i < 6)
                force(i, username, file, location);
            else
                prompt();

        }, 1000);
    }

    function base64(option, input){
        if(option == '-d')
            term.write(atob(input));
        else
            term.write(btoa(input));
            
        prompt();
    }
}

async function validateForce(username, file, location){
    const res = await fetch('/api/terminal/force', {
        method: 'POST',
        body: JSON.stringify({
            username, file, location
        })
    });
    
    return await res.json();
}

async function validateSSH(connection){
    const res = await fetch('/api/terminal/ssh', {
        method: 'POST',
        body: JSON.stringify({
            connection
        })
    });
    
    return await res.json();
}

async function validateSSHPW(pw){
    const res = await fetch('/api/terminal/sshPW', {
        method: 'POST',
        body: JSON.stringify({
            pw
        })
    });
    
    return await res.json();
}